- name: backend setup
  hosts: all
  become: yes
  tasks:

    - name: enable NodeJS version module
      ansible.builtin.shell: dnf module disable nodejs -y

    - name: Enable NodeJS module for v20
      ansible.builtin.shell: dnf module disable nodejs -y

    - name: Install nodejs
      ansible.builtin.dnf:
       name: nodejs
       state: installed

    - name: Adding application user
      ansible.builtin.user:
       name: expense

    - name: clean the old content
      ansible.builtin.file:
       path: /app
       state: absent

    - name: create app directory
      ansible.builtin.file:
       path: /app
       state: directory

    - name: Download and extract app content
      ansible.builtin.unarchive:
       src: https://expense-artifacts.s3.amazonaws.com/expense-backend-v2.zip
       dest: /app
       remote_src: yes


    - name: Download NodeJS dependencies
      community.general.npm:
       path: app
       state: latest

    - name: copy Backend Service file
      ansible.builtin.copy:
       src: backend.service
       dest: /etc/systemd/system/backend.service

    - name: Install Python MySQL client
      ansible.builtin.pip:
       name:
         - PyMySQL
         - cryptography
       executable: pip3.9

    - name: Load Schema
      Community.mysql.mysql_db:
       state: import
       name: all
       target: /app/schema/backend.sql
       login_user: root
       login_password: ExpenseApp@1
       login_host: mysql-dev.donthi123.online


    - name: Start backend service
      ansible.builtin.systemd_service:
       name: backend
       state: restarted
       enabled: yes
       daemon_reload: yes




